# 応用情報 類似問題検索プロジェクト (oyo_similar_question_finder)

このプロジェクトは、応用情報技術者試験の過去問データを収集し、テキストのベクトル化技術を用いて類似した問題を見つけ出すことを目的としています。

## データ同期システム

このアプリケーションには、Google Apps Script (GAS) を利用して、学習データ（問題のチェック状態、リアクション、お気に入りなど）をクラウドに保存・同期する機能が含まれています。これにより、異なるデバイス間でも同じ学習環境を共有することができます。

### 主な機能

-   **ユーザー認証**: ユーザーIDとパスワードによる簡単な認証システム。
-   **データ同期**: 学習データを手動または自動でクラウドと同期。
-   **マルチデバイス対応**: 一度設定すれば、どのデバイスからでも同じデータにアクセス可能。

### 設定方法

1.  **バックエンドの準備**: `GAS_SETUP.md` の手順に従って、ご自身のGoogleアカウントにバックエンドとなるGoogle Apps Scriptのウェブアプリケーションをデプロイしてください。
2.  **アプリへの設定**:
    -   アプリ画面右上の「👤（人型）」アイコンからユーザー登録とログインを行います。
    -   アプリ画面右上の「⚙️（歯車）」アイコンをクリックして同期設定モーダルを開きます。
    -   デプロイ時に取得したGASの**ウェブアプリURL**を設定欄に入力し、保存します。

以上で設定は完了です。設定後は、手動でのアップロード/ダウンロードや、必要に応じた自動同期が行われます。

## 問題データの生成

このアプリケーションは、ベクトル化された問題データ（`gemma_embeddings.json`）を基に、類似問題を検索・表示します。このデータはColab環境で生成されることを想定しています。

### データ生成ワークフロー

1.  **Colabでのデータ生成**:
    -   Colab環境で問題のベクトル化処理を実行し、`gemma_embeddings.json`を生成します。このファイルには、各問題の埋め込みベクトルが含まれています。
    -   **重要**: `gemma_embeddings.json`をプロジェクトの`03_html_output/`ディレクトリに配置してください。

2.  **類似度計算と埋め込み**:
    -   `03_html_output/main.py`スクリプトが`gemma_embeddings.json`を読み込み、類似度計算を行い、アプリケーションが利用する形式のJavaScriptファイル（`problem_data.js`）を生成します。
    -   このスクリプトは、設定された類似度閾値（デフォルトは0.85）に基づいて類似問題を抽出します。
    ```bash
    py 03_html_output/main.py
    ```

3.  **HTMLへのデータ埋め込み**:
    -   `03_html_output/generate_html.py`スクリプトが`problem_data.js`のデータと`index_template.html`を結合し、最終的な`index.html`ファイルを生成します。
    ```bash
    py 03_html_output/generate_html.py
    ```
    -   これにより、`index.html`に問題データが直接埋め込まれ、アプリケーションが起動時に利用できるようになります。

## テスト環境の設定

このプロジェクトでは、テスト実行時にGoogle Apps Script (GAS) のURLが必要となります。
セキュリティと管理の容易さを考慮し、GAS URLをリポジトリにコミットせずに設定できる仕組みを導入しました。

### 設定手順

新しい開発者がプロジェクトをクローンした場合、以下の手順でテスト環境を設定してください。

1.  **テスト設定ファイルの作成:**
    テストを実行する前に、まずプロジェクトのルートディレクトリで以下のコマンドを実行します。

    ```bash
    py create_test_config.py
    ```

    このコマンドは、テスト用の設定ファイルである `.test_settings.local` を作成し、同時にそのファイルがGitリポジトリにコミットされないよう、自動的に `.gitignore` へ追記します。

2.  **テスト用GAS URLの設定:**
    作成された `.test_settings.local` ファイルを開き、`TEST_GAS_URL`変数に**テスト用のGAS Web Apps URL**を設定してください。

    ```python
    # .test_settings.local
    # このファイルは.gitignoreで無視されます。
    # テスト用のGAS URLをここに設定してください。
    # 例: TEST_GAS_URL = "https://script.google.com/macros/s/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx/exec"
    TEST_GAS_URL = "https://script.google.com/macros/s/YOUR_TEST_GAS_URL_HERE/exec"
    ```
    `YOUR_TEST_GAS_URL_HERE`の部分を、ご自身でデプロイしたテスト用のGAS Web Apps URLに置き換えてください。**本番環境のGAS URLを使用しないことを強く推奨します。**

3.  **テストの実行:**
    設定が完了したら、通常通りテストを実行できます。

    ```bash
    py run_all_tests.py
    ```

    テストフレームワークは、`.test_settings.local`から`TEST_GAS_URL`を自動的に読み込み、テスト時にブラウザの`localStorage`に設定して使用します。

## 開発ワークフロー

### GASコードの管理とデプロイ

GASコードは`gas/`ディレクトリで管理されており、claspを使用してデプロイできます。

#### 初回セットアップ

1. **claspのインストール**:
   ```bash
   npm install -g @google/clasp
   ```

2. **Googleアカウントでログイン**:
   ```bash
   clasp login
   ```

3. **Apps Script APIを有効化**:
   - https://script.google.com/home/usersettings にアクセス
   - 「Google Apps Script API」をオンにする
   - 数分待つ（APIの有効化が反映されるまで）

4. **スクリプトIDの設定**:
   - GASエディタで「プロジェクトの設定」→「スクリプトID」をコピー
   - `gas/.clasp.json`を開き、`<YOUR_SCRIPT_ID>`を実際のスクリプトIDに置き換え

#### デプロイ

```bash
py deploy_gas.py
```

または、コマンドラインから：

```bash
cd gas
clasp push
```

#### GASから最新コードを取得

```bash
py pull_gas.py
```

詳細は`GAS_SETUP.md`を参照してください。

## テスト要件（TODO）

> **注意**: 現在、テストファイルは一旦削除されています。以下は将来実装すべきテスト要件のリストです。

### 実装すべきテストケース

#### 1. メインページのテスト
- [ ] **コンテンツの表示**: JSONデータが読み込まれ、カテゴリリストが正しく描画されること
- [ ] **進捗バー**: 積み上げ式プログレスバーが学習状態に応じて正しく表示されること

#### 2. UI インタラクションのテスト
- [ ] **ナビゲーション**: カテゴリをクリックして詳細画面に遷移し、戻るボタンで戻れること
- [ ] **ソート順の永続化**: ソート順を変更し、リロード後も設定が維持されること
- [ ] **リアクションボタン**: いいね・推しボタンのクリックと永続化が正しく動作すること
- [ ] **チェックボックス**: チェック操作で問題の学習状態が更新され、進捗バーに反映されること
- [ ] **アコーディオン**: 類似問題のアコーディオン開閉が正しく動作すること
- [ ] **大項目アコーディオン**: 大項目のアコーディオン開閉と永続化が正しく動作すること
- [ ] **未着手フィルター**: 未着手のみ表示フィルターが正しく動作すること
- [ ] **復習ハイライト**: 復習タイミングが来た問題がハイライトされること
- [ ] **ストレージリセット**: リセットボタンでデータが正しくクリアされること
- [ ] **アーカイブ機能**: アーカイブ、フィルター、復元が正しく動作すること
- [ ] **検索機能**: （もし実装されていれば）キーワード検索が正しく動作すること

#### 3. 認証・同期のテスト (⭐重要)
- [x] **基本的なログイン**: 正常な認証情報でログインできること (既存: `login_test_user` fixture)
- [ ] **自動ログイン**: リロード後もセッショントークンによりログイン状態が維持されること
- [ ] **ログアウト**: ログアウト機能が正しく動作すること
- [ ] **無効なログイン**: 不正な認証情報でログインを試みた際に、適切なエラーが表示されること
- [ ] **データ保存**: 学習データがクラウドに正しく保存されること
- [ ] **データ読み込み**: クラウドから学習データが正しく読み込まれること
- [ ] **競合検出**: 複数デバイスでの同時編集時に競合が検出され、ユーザーに通知されること

#### 4. お気に入り機能のテスト
- [ ] **お気に入り追加/削除**: スター機能が正しく動作すること
- [ ] **お気に入りフィルター**: お気に入りのみ表示フィルターが動作すること
- [ ] **お気に入りの永続化**: リロード後もお気に入り状態が維持されること

#### 5. エッジケースと堅牢性のテスト
- [ ] **空のカテゴリ**: 問題データが含まれないカテゴリが正しく処理されること
- [ ] **ネットワークエラー**: データ同期中にネットワークが切断された場合の挙動（エラーメッセージ表示など）

### テスト実装時の注意事項

#### 技術スタック
- **ブラウザ自動化**: Selenium WebDriver
- **テスト構成**:
  - `.vscode/settings.json`: VSCodeテストエクスプローラー設定

#### 重要な設計パターン
1. **session スコープのログイン**: 全テストで1回だけログインし、テスト実行時間を短縮
2. **ヘッドレスモード**: CI/CD環境での実行を考慮した設定 簡単に変更可能　実行はコマンドでもVSCODEでもできるように
3. テストの実行設定を簡単に変えられるようなローカルファイルを作る.pyを作る。ヘッドレスありなし

